#!/bin/bash

# ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥ —Å–≤–æ—é —Å–µ—Ç—å 
NETWORK="192.168.1.0/24"          # –¢–≤–æ—è —Å–µ—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: 192.168.0.0/24)
INTERFACE="eth0"                  # –¢–≤–æ–π —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–ø—Ä–æ–≤–µ—Ä—å: ip a)
SCAN_DELAY="1s"                   # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (—á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å —Å–µ—Ç—å)
TIMESTAMP=$(date +%Y%m%d_%H%M%S)  # –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤
LOG_DIR="/tmp/printer_audit"       # –ü–∞–ø–∫–∞ –¥–ª—è –ª–æ–≥–æ–≤ (–º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –Ω–∞ /var/log/)
SUSPECT_FILE="${LOG_DIR}/suspicious_activity_${TIMESTAMP}.log"
ALIVE_HOSTS="${LOG_DIR}/alive_hosts_${TIMESTAMP}.txt"
PRINT_HOSTS="${LOG_DIR}/print_hosts_${TIMESTAMP}.txt"
DETAILED_SCAN="${LOG_DIR}/detailed_scan_${TIMESTAMP}"

# ==================== –ë–ï–õ–´–ô –°–ü–ò–°–û–ö –ë–†–ï–ù–î–û–í –ü–†–ò–ù–¢–ï–†–û–í ====================
# üîß –ù–ê–°–¢–†–û–ô–ö–ê: –î–æ–±–∞–≤–ª—è–π —Å—é–¥–∞ –í–°–ï –±—Ä–µ–Ω–¥—ã –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ —Å–∫–∞–Ω–∏—Ä—É–µ–º–æ–π —Å–µ—Ç–∏
# üìù –§–æ—Ä–º–∞—Ç: "HP|Canon|Xerox|Epson" - —á–µ—Ä–µ–∑ | –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤
# üí° –ü—Ä–∏–º–µ—Ä: "HP|Canon|Xerox|RICOH|KYOCERA|Epson|Brother|Lexmark"
PRINTER_BRANDS="HP|Canon|Xerox|RICOH|KYOCERA|Epson|Brother|Lexmark|Konica|Minolta|OKI|Samsung|Sharp|Toshiba"

# ==================== –ß–ï–†–ù–´–ô –°–ü–ò–°–û–ö (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û) ====================
# ‚ö†Ô∏è –ò—Å–∫–ª—é—á–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –±—Ä–µ–Ω–¥—ã, –¥–æ–±–∞–≤—å –∏—Ö —Å—é–¥–∞
# ‚ùó –ü—Ä–∏–º–µ—Ä: "Unknown|Generic|Fake" - —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å —Ç–∞–∫–∏–º–∏ –±—Ä–µ–Ω–¥–∞–º–∏ –±—É–¥—É—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–º–∏
BLACKLIST_BRANDS="Unknown|Generic|Fake"

# ==================== –ù–ê–°–¢–†–û–ô–ö–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò ====================
set -euo pipefail  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
export LANG=C.UTF-8  # –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Ä—É—Å—Å–∫–∏—Ö –±—É–∫–≤

# ==================== –ü–†–û–í–ï–†–ö–ò –ü–ï–†–ï–î –ó–ê–ü–£–°–ö–û–ú ====================
echo "üîç [–ó–ê–ü–£–°–ö –ê–£–î–ò–¢–ê –ü–†–ò–ù–¢–ï–†–û–í]"
echo "‚è∞ –í—Ä–µ–º—è: $(date)"
echo "üìÅ –õ–æ–≥–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å: $LOG_DIR"
echo "üîß –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –±—Ä–µ–Ω–¥–æ–≤: $PRINTER_BRANDS"
if [ -n "$BLACKLIST_BRANDS" ]; then
    echo "‚ö´ –ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –±—Ä–µ–Ω–¥–æ–≤: $BLACKLIST_BRANDS"
fi
echo "=========================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ nmap
if ! command -v nmap >/dev/null 2>&1; then
    echo "‚ùå –û–®–ò–ë–ö–ê: Nmap –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo "üíª –£—Å—Ç–∞–Ω–æ–≤–∏ –µ–≥–æ: sudo apt install nmap"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ (–Ω—É–∂–Ω—ã root –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π)
if [ "$EUID" -ne 0 ]; then
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –±–µ–∑ root –ø—Ä–∞–≤"
    echo "   –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å"
    sleep 2
fi

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p "$LOG_DIR" || {
    echo "‚ùå –ù–µ –º–æ–≥—É —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É: $LOG_DIR"
    exit 1
}

# ==================== –§–£–ù–ö–¶–ò–ò ====================
# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
log_suspicious() {
    local message=$1    # –ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å
    local ip=$2         # IP –∞–¥—Ä–µ—Å
    local details=$3    # –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏
    
    echo "üö® –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–ê–Ø –ê–ö–¢–ò–í–ù–û–°–¢–¨: $message" | tee -a "$SUSPECT_FILE"
    echo "   üìç IP: $ip" | tee -a "$SUSPECT_FILE"
    echo "   üìù –î–µ—Ç–∞–ª–∏: $details" | tee -a "$SUSPECT_FILE"
    echo "   ‚è∞ –í—Ä–µ–º—è: $(date)" | tee -a "$SUSPECT_FILE"
    echo "----------------------------------------" | tee -a "$SUSPECT_FILE"
}

# ==================== –®–ê–ì 1: –ü–û–ò–°–ö –ñ–ò–í–´–• –£–°–¢–†–û–ô–°–¢–í ====================
echo "üì° –®–ê–ì 1: –ò—â–µ–º –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ —Å–µ—Ç–∏..."
echo "   –°–µ—Ç—å: $NETWORK"
echo "   –≠—Ç–æ –∑–∞–π–º–µ—Ç 1-2 –º–∏–Ω—É—Ç—ã..."

if ! nmap -sn -T4 --max-retries 1 --host-timeout 30s "$NETWORK" -oG "$ALIVE_HOSTS" > /dev/null 2>&1; then
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Ç–∏!"
    exit 1
fi

# –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ IP –∞–¥—Ä–µ—Å–∞ –∂–∏–≤—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
grep "Up" "$ALIVE_HOSTS" | awk '{print $2}' > "${ALIVE_HOSTS}.ips"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∂–∏–≤—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
if [ ! -s "${ALIVE_HOSTS}.ips" ]; then
    echo "üò¥ –í —Å–µ—Ç–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤. –ó–∞–≤–µ—Ä—à–∞–µ–º."
    exit 0
fi

LIVE_COUNT=$(wc -l < "${ALIVE_HOSTS}.ips")
echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: $LIVE_COUNT"

# ==================== –®–ê–ì 2: –ü–û–ò–°–ö –ü–û–†–¢–û–í –ü–†–ò–ù–¢–ï–†–û–í ====================
echo "üñ®Ô∏è  –®–ê–ì 2: –ò—â–µ–º –ø—Ä–∏–Ω—Ç–µ—Ä—ã (–ø–æ—Ä—Ç—ã 9100, 515, 631)..."
echo "   –°–∫–∞–Ω–∏—Ä—É–µ–º $LIVE_COUNT —É—Å—Ç—Ä–æ–π—Å—Ç–≤..."

if ! nmap -p 9100,515,631 --open --max-retries 1 --host-timeout 30s -T4 \
    -iL "${ALIVE_HOSTS}.ips" -oG "$PRINT_HOSTS" > /dev/null 2>&1; then
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Ä—Ç–æ–≤!"
    exit 1
fi

# –°—á–∏—Ç–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–∏–Ω—Ç–µ—Ä—ã
PRINT_COUNT=$(grep -c "open" "$PRINT_HOSTS" || true)
echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å –ø–æ—Ä—Ç–∞–º–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤: $PRINT_COUNT"

# –°–æ—Ö—Ä–∞–Ω—è–µ–º IP –∞–¥—Ä–µ—Å–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
grep "open" "$PRINT_HOSTS" | awk '{print $2}' > "${PRINT_HOSTS}.ips"

# ==================== –®–ê–ì 3: –ü–†–û–í–ï–†–ö–ê –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–´–• –£–°–¢–†–û–ô–°–¢–í ====================
if [ -s "${PRINT_HOSTS}.ips" ]; then
    echo "üîç –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞..."
    echo "   ‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: —ç—Ç–æ –∑–∞–π–º–µ—Ç 3-10 –º–∏–Ω—É—Ç!"
    echo "   –°–∫–∞–Ω–∏—Ä—É–µ–º $PRINT_COUNT —É—Å—Ç—Ä–æ–π—Å—Ç–≤..."
    
    # –ì–ª—É–±–æ–∫–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    if ! nmap -O -sV -T4 --osscan-guess --max-retries 1 --host-timeout 2m \
        --script="ipp-enum,printer-info,smb2-security-mode" \
        -iL "${PRINT_HOSTS}.ips" -oA "$DETAILED_SCAN" > /dev/null 2>&1; then
        echo "‚ö†Ô∏è  –ë—ã–ª–∏ –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    while IFS= read -r TARGET_IP; do
        echo "   üîé –ü—Ä–æ–≤–µ—Ä—è–µ–º: $TARGET_IP"
        
        # –î–æ—Å—Ç–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ nmap
        OS_INFO=$(grep -A 15 "Nmap scan report for $TARGET_IP" "${DETAILED_SCAN}.nmap" 2>/dev/null | \
                 grep -E "Running|OS details|Aggressive OS guesses" | head -3 || echo "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞")
        
        SERVICE_INFO=$(grep -A 20 "Nmap scan report for $TARGET_IP" "${DETAILED_SCAN}.nmap" 2>/dev/null | \
                      grep -E "9100|515|631|445|135" | grep -E "open|filtered" || echo "–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏")
        
        SCRIPT_INFO=$(grep -A 10 -B 2 "$TARGET_IP" "${DETAILED_SCAN}.nmap" 2>/dev/null | \
                     grep -E "printer-info|ipp-enum|message_signing" | head -5 || echo "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
        
        # ===== –ü–†–û–í–ï–†–Ø–ï–ú –ü–†–ò–ó–ù–ê–ö–ò –í–ó–õ–û–ú–ê =====
        SUSPICIOUS=false
        REASONS=()
        
        # 1. Windows\|Linux\|Mac\|macOS\|Apple\|Darwin –Ω–∞ –ø–æ—Ä—Ç–∞—Ö –ø—Ä–∏–Ω—Ç–µ—Ä–∞ - –ì–õ–ê–í–ù–´–ô –ü–†–ò–ó–ù–ê–ö!
        if echo "$OS_INFO" | grep -qi "Windows\|Linux\|Mac\|macOS\|Apple\|Darwin" && \
           echo "$SERVICE_INFO" | grep -q "9100/open\|631/open"; then
            SUSPICIOUS=true
            REASONS+=("–ö–æ–º–ø—å—é—Ç–µ—Ä –≤—ã–¥–∞–µ—Ç —Å–µ–±—è –∑–∞ –ø—Ä–∏–Ω—Ç–µ—Ä")
        fi
        
        # 2. –û—Ç–∫–ª—é—á–µ–Ω–∞ SMB –ø–æ–¥–ø–∏—Å—å - —É—è–∑–≤–∏–º–æ—Å—Ç—å –¥–ª—è –∞—Ç–∞–∫
        if echo "$SCRIPT_INFO" | grep -q "message_signing: disabled"; then
            SUSPICIOUS=true
            REASONS+=("SMB –ø–æ–¥–ø–∏—Å—å –æ—Ç–∫–ª—é—á–µ–Ω–∞ - —É—è–∑–≤–∏–º–æ—Å—Ç—å")
        fi
        
        # 3. Windows —Å–ª—É–∂–±—ã –Ω–∞ "–ø—Ä–∏–Ω—Ç–µ—Ä–µ"
        if echo "$SERVICE_INFO" | grep -q "445/open.*microsoft-ds\|135/open.*msrpc"; then
            SUSPICIOUS=true
            REASONS+=("–ù–∞–π–¥–µ–Ω Windows-—Å–µ—Ä–≤–µ—Ä –≤–º–µ—Å—Ç–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞")
        fi
        
        # 4. üîß –ü–†–û–í–ï–†–ö–ê –ü–û –ë–ï–õ–û–ú–£ –ò –ß–ï–†–ù–û–ú–£ –°–ü–ò–°–ö–ê–ú –ë–†–ï–ù–î–û–í
        # üìù –õ–æ–≥–∏–∫–∞: –ï—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–Ω—Ç–µ—Ä–µ, –Ω–æ –Ω–µ—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –±—Ä–µ–Ω–¥–æ–≤ –ò–õ–ò –µ—Å—Ç—å –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –±—Ä–µ–Ω–¥—ã
        if echo "$SCRIPT_INFO" | grep -q "printer-info"; then
            # üü¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞: –µ—Å–ª–∏ –±—Ä–µ–Ω–¥ –ù–ï –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ
            if ! echo "$SCRIPT_INFO" | grep -qi "$PRINTER_BRANDS"; then
                SUSPICIOUS=true
                REASONS+=("–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –∏–∑ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞ –±—Ä–µ–Ω–¥–æ–≤")
            fi
            
            # üî¥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞: –µ—Å–ª–∏ –±—Ä–µ–Ω–¥ –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ
            if echo "$SCRIPT_INFO" | grep -qi "$BLACKLIST_BRANDS"; then
                SUSPICIOUS=true
                REASONS+=("–û–±–Ω–∞—Ä—É–∂–µ–Ω –±—Ä–µ–Ω–¥ –∏–∑ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞")
            fi
        fi
        
        # ===== –î–ï–ô–°–¢–í–ò–Ø –ï–°–õ–ò –ù–ê–®–õ–ò –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û–ï –£–°–¢–†–û–ô–°–¢–í–û =====
        if [ "$SUSPICIOUS" = true ]; then
            REASON_STR=$(IFS='; '; echo "${REASONS[*]}")
            log_suspicious "–í–û–ó–ú–û–ñ–ù–ê –ü–û–î–ú–ï–ù–ê –ü–†–ò–ù–¢–ï–†–ê" "$TARGET_IP" "$REASON_STR"
            echo "      ‚ùó –í–ù–ò–ú–ê–ù–ò–ï: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É–≥—Ä–æ–∑–∞!"
            echo "      üñ•Ô∏è  OS: $OS_INFO"
            echo "      üõ†Ô∏è  Services: $SERVICE_INFO"
            echo "      üìä Scripts: $SCRIPT_INFO"
        else
            echo "      ‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –ø–æ—Ä—è–¥–∫–µ (–Ω–∞—Å—Ç–æ—è—â–∏–π –ø—Ä–∏–Ω—Ç–µ—Ä)"
        fi
        
    done < "${PRINT_HOSTS}.ips"
else
    echo "‚úÖ –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
fi

# ==================== –®–ê–ì 4: –ü–†–û–í–ï–†–ö–ê –°–ï–¢–ï–í–´–• –ü–†–û–¢–û–ö–û–õ–û–í ====================
echo ""
read -p "‚ùì –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç—å –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ LLMNR/NBNS? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "üì° –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ (60 —Å–µ–∫—É–Ω–¥)..."
    
    if command -v timeout >/dev/null 2>&1; then
        BROADCAST_CHECK=$(timeout 60 nmap --script broadcast-llmnr-discover,broadcast-nbns-discover -e "$INTERFACE" 2>&1 || true)
    else
        echo "‚ö†Ô∏è  –£—Ç–∏–ª–∏—Ç–∞ timeout –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞—Ç—è–Ω—É—Ç—å—Å—è"
        BROADCAST_CHECK=$(nmap --script broadcast-llmnr-discover,broadcast-nbns-discover -e "$INTERFACE" 2>&1 | head -50 || true)
    fi
    
    if echo "$BROADCAST_CHECK" | grep -q "discovered"; then
        echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å–µ—Ç–µ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å LLMNR/NBNS"
        echo "$BROADCAST_CHECK" | grep "discovered" | while read -r line; do
            log_suspicious "–°–ï–¢–ï–í–ê–Ø –ê–ö–¢–ò–í–ù–û–°–¢–¨" "N/A" "$line"
        done
    else
        echo "‚úÖ –°–µ—Ç–µ–≤—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã –≤ –ø–æ—Ä—è–¥–∫–µ"
    fi
fi

# ==================== –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢ ====================
echo ""
echo "=========================================================="
echo "üéâ –ê–£–î–ò–¢ –ó–ê–í–ï–†–®–ï–ù: $(date)"
echo "=========================================================="

if [ -f "$SUSPECT_FILE" ] && [ -s "$SUSPECT_FILE" ]; then
    SUSPECT_COUNT=$(grep -c "–ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–ê–Ø –ê–ö–¢–ò–í–ù–û–°–¢–¨" "$SUSPECT_FILE")
    echo "üö® –ù–ê–ô–î–ï–ù–û –£–ì–†–û–ó: $SUSPECT_COUNT"
    echo "üìÑ –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ —Ñ–∞–π–ª–µ: $SUSPECT_FILE"
    echo ""
    echo "‚ö° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:"
    echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ IP –∞–¥—Ä–µ—Å–∞ –∏–∑ –æ—Ç—á–µ—Ç–∞"
    echo "   2. –ò–∑–æ–ª–∏—Ä—É–π—Ç–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ—Ç —Å–µ—Ç–∏"
    echo "   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ —ç—Ç–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö"
    echo "   4. üîß –û–±–Ω–æ–≤–∏—Ç–µ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –±—Ä–µ–Ω–¥–æ–≤ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ"
else
    echo "‚úÖ –£–ì–†–û–ó –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ! –°–µ—Ç—å –∑–∞—â–∏—â–µ–Ω–∞."
fi

echo ""
echo "üìä –≤—Å–µ —Ñ–∞–π–ª—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: $LOG_DIR"
echo "üîç –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å –¥–µ—Ç–∞–ª—è–º–∏: ${DETAILED_SCAN}.nmap"
echo "üîß –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –±—Ä–µ–Ω–¥–æ–≤: $PRINTER_BRANDS"
if [ -n "$BLACKLIST_BRANDS" ]; then
    echo "‚ö´ –ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –±—Ä–µ–Ω–¥–æ–≤: $BLACKLIST_BRANDS"
fi
echo "üí° –ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Å–ø–∏—Å–∫–∏, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ PRINTER_BRANDS –∏ BLACKLIST_BRANDS"
echo "=========================================================="

# –ö–æ–ø–∏—Ä—É–µ–º –ª–æ–≥–∏ –≤ —É–¥–æ–±–Ω–æ–µ –º–µ—Å—Ç–æ
cp "$SUSPECT_FILE" "/tmp/last_printer_audit.log" 2>/dev/null || true
echo "üìã –ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω: /tmp/last_printer_audit.log"
